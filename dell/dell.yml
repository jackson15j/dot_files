---
# https://wiki.archlinux.org/index.php/Dell_XPS_13_(9370)
- name: Running the Dell XPS 13 ansible playbook...
  hosts: localhost
  tasks:
    - name: Get repo base path
      command: git rev-parse --show-toplevel
      register: repo_base_path

    - set_fact:
        base_path: '{{repo_base_path.stdout}}/dell/'

    - name: Install Dell packages
      become: true
      become_method: sudo
      pacman:
        name: "{{ item }}"
        state: latest
      with_items:
        # Was: https://wiki.archlinux.org/index.php/Touchpad_Synaptics
        # Now: https://wiki.archlinux.org/index.php/Libinput
        # Further settings in: /etc/X11/xorg.conf.d/30-touchpad.conf.
        - xf86-input-libinput  # xf86-input-synaptics is deprecated.
        # Dell BIOS updating = Download exe to a pendrive and using the Bios
        # Flash Update at boot time (F12), since I'm legacy (instead of UEFI).
        # www.dell.com/support/article/uk/en/ukdhs1/sln171755/updating-the-dell-bios-in-linux-and-ubuntu-environments?lang=en
        # Dell component FW updates:
        # https://wiki.archlinux.org/index.php/Flashing_BIOS_from_Linux#fwupd
        # https://fwupd.org/lvfs/device/7ceaf7a8-0611-4480-9e30-64d8de420c7c
        - fwupd

    - name: Copy suspend-to-hibernate.service script to /etc/systemd/system/
      become: true
      become_method: sudo
      copy:
        src: '{{base_path}}suspend-to-hibernate.service'
        dest: /etc/systemd/system/
        owner: 'root'
        group: 'root'
        mode: 0755

    - name: Enable suspend-to-hibernate service
      become: true
      become_method: sudo
      systemd:
        name: suspend-to-hibernate.service
        enabled: True
        state: started
        # user: yes

    - name: Copy logind.conf script to /etc/systemd/
      become: true
      become_method: sudo
      copy:
        src: '{{base_path}}logind.conf'
        dest: /etc/systemd/
        owner: 'root'
        group: 'root'
        mode: 0755

    - name: Restart logind service to enable suspend with delayed hibernate
      # See: https://wiki.archlinux.org/index.php/Power_management#ACPI_events.
      become: true
      become_method: sudo
      systemd:
        name: systemd-logind.service
        enabled: True
        state: restarted

    - name: Copy 30-touchpad.conf script to /etc/X11/xorg.conf.d/
      become: true
      become_method: sudo
      copy:
        src: '{{base_path}}30-touchpad.conf'
        dest: /etc/X11/xorg.conf.d/
        owner: 'root'
        group: 'root'
        mode: 0755

    - name: Apply Gnome touchpad settings
      # Gnome (Wayland) stamps over my xorg touch pad settings, so lets fix
      # them up.
      # FIXME: Can the xorg and Gnome settings be consolidated?
      dconf:
        key: "{{item.path}}"
        value: "{{item.value}}"
        state: present
      with_items:
        - {path: "/org/gnome/desktop/peripherals/touchpad/click-method",
           value: "'areas'"}
        - {path: "/org/gnome/desktop/peripherals/touchpad/edge-scrolling-enabled",
           value: "false"}
        - {path: "/org/gnome/desktop/peripherals/touchpad/natural-scroll",
           value: "false"}
        - {path: "/org/gnome/desktop/peripherals/touchpad/speed",
           value: "0.9"}
        - {path: "/org/gnome/desktop/peripherals/touchpad/tap-to-click",
           value: "true"}
        - {path: "/org/gnome/desktop/peripherals/touchpad/two-finger-scrolling-enabled",
           value: "true"}

    # TODO: script printer updating/configuration steps:
    # https://bbs.archlinux.org/viewtopic.php?id=201719
    # * Plugin update with: `hp-plugin`.
    # * Printer config with: `sudo hp-setup -i`.
